<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Permintaan Sparepart v2 (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 1. Tambahkan SDK EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- 2. Tambahkan Library Chart.js untuk Dasbor -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .filter-btn.active { background-color: #2563eb; color: white; }
        .filter-btn.inactive { background-color: #4a5568; color: #d1d5db; }
        .nav-link.active { background-color: #2563eb; }
        @media print { body, #app-container, .container, #main-nav, #loginPage, #formPage, #adminPage, #dashboardPage, .modal { display: none !important; } .print-container { display: block !important; } }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Navigasi Utama (ditampilkan setelah login) -->
    <nav id="main-nav" class="bg-gray-800 shadow-md p-4 hidden">
        <div class="container mx-auto flex justify-between items-center">
            <div id="nav-links" class="flex items-center space-x-2">
                 <!-- Navigasi Dinamis -->
            </div>
            <div class="flex items-center space-x-4">
                <span id="welcomeMessage" class="text-gray-300 hidden sm:block"></span>
                <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Kontainer Halaman -->
    <div id="app-container" class="container mx-auto p-4 md:p-8">
        
        <!-- Halaman Login -->
        <div id="loginPage">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Form Pemesanan Part</h1>
                <p class="text-gray-400 mt-2"> </p>
            </header>
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-md mx-auto">
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="email" name="email" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                </form>
                <p id="loginStatus" class="mt-4 text-center text-red-400"></p>
            </div>
        </div>

        <!-- Halaman Dasbor (Admin) -->
        <div id="dashboardPage" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Dasbor Analitik</h1>
                <p class="text-gray-400 mt-2">Ringkasan data permintaan sparepart.</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <p class="text-sm text-gray-400">Total Permintaan</p>
                    <p id="totalRequests" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <p class="text-sm text-gray-400">Menunggu Persetujuan</p>
                    <p id="pendingRequests" class="text-4xl font-bold mt-2 text-yellow-400">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <p class="text-sm text-gray-400">Part Terpopuler</p>
                    <p id="popularPart" class="text-lg sm:text-2xl font-bold mt-2 truncate">-</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg text-center">
                    <p class="text-sm text-gray-400">Cabang Teraktif</p>
                    <p id="activeBranch" class="text-lg sm:text-2xl font-bold mt-2">-</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Permintaan per Cabang</h3>
                <canvas id="requestsByBranchChart"></canvas>
            </div>
        </div>

        <!-- Halaman Formulir -->
        <div id="formPage" class="hidden">
             <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Formulir Permintaan Sparepart</h1>
                <p class="text-gray-400 mt-2">Isi detail permintaan di bawah ini.</p>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 max-w-4xl mx-auto">
                <form id="requestForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label for="namaPemesan" class="block text-sm font-medium text-gray-300 mb-1">Nama Pemesan</label>
                            <input type="text" id="namaPemesan" name="namaPemesan" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                        </div>
                        <div>
                            <label for="cabang" class="block text-sm font-medium text-gray-300 mb-1">Cabang</label>
                            <select id="cabang" name="cabang" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                                <option value="">Pilih Cabang</option>
                                <option value="Pungkur">Pungkur</option><option value="Ariajipang">Ariajipang</option><option value="Cibiru">Cibiru</option><option value="Kopo">Kopo</option><option value="Karawang">Karawang</option><option value="Cirebon">Cirebon</option><option value="Tasikmalaya">Tasikmalaya</option><option value="Garut">Garut</option><option value="Jatibarang">Jatibarang</option>
                            </select>
                        </div>
                        <div>
                            <label for="jenisOrder" class="block text-sm font-medium text-gray-300 mb-1">Jenis Order</label>
                            <select id="jenisOrder" name="jenisOrder" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                                <option value="Regular">Regular</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Costumer Order">Costumer Order</option>
                                <option value="Pihak Ke-3">Pihak Ke-3</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="keterangan" class="block text-sm font-medium text-gray-300 mb-1">Keterangan (Opsional)</label>
                            <textarea id="keterangan" name="keterangan" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white"></textarea>
                        </div>
                    </div>
                    
                    <div class="border-t border-b border-gray-700 py-6 my-6">
                        <h3 class="text-lg font-semibold mb-2 text-gray-200">Unggah via CSV</h3>
                         <p class="text-sm text-gray-400 mb-4">Format: Kolom A untuk Kode Part, Kolom B untuk Jumlah. Tanpa baris header.</p>
                        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                            <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                            <button type="button" id="processCsvBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Proses CSV</button>
                        </div>
                        <p id="csvStatus" class="mt-2 text-sm text-yellow-400"></p>
                    </div>

                    <h3 class="text-lg font-semibold mb-2 text-gray-200">Item Sparepart (Manual atau Hasil Pratinjau CSV)</h3>
                    <div id="partsContainer" class="space-y-4"></div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <button type="button" id="addPartBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Baris Manual</button>
                        <button type="submit" id="submitButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg inline-flex items-center">
                            <svg id="submitIcon" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                            <span id="submitText">Ajukan Permintaan</span>
                            <div id="submitLoader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 mr-2 hidden"></div>
                        </button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </div>
        </div>

        <!-- Halaman Admin (Daftar Permintaan) -->
        <div id="adminPage" class="hidden">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-semibold">Daftar Permintaan</h2>
                    <div class="w-full md:w-auto flex flex-col md:flex-row items-center gap-4">
                         <div class="relative w-full md:w-64">
                            <input type="search" id="searchInput" name="searchInput" placeholder="Cari ID, Nama, Cabang..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 pl-10 pr-4 text-white text-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                               <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="filterPending" class="filter-btn active font-semibold py-2 px-4 rounded-md text-sm">Belum Disetujui</button>
                            <button id="filterAll" class="filter-btn inactive font-semibold py-2 px-4 rounded-md text-sm">Semua</button>
                            <button id="exportCsvBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md text-sm">Ekspor CSV</button>
                        </div>
                    </div>
                </div>
                <div id="loader" class="flex justify-center items-center py-10">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
                </div>
                <div id="requestsContainer" class="space-y-6"></div>
                <p id="noDataMessage" class="text-center text-gray-500 py-10 hidden">Belum ada data permintaan.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
       <!-- ... Konten Modal tidak berubah ... -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBaDFh2VUt5_4miahJYVTLmXS0KI_kr-iA",
          authDomain: "aplikasi-sparepart-45219.firebaseapp.com",
          projectId: "aplikasi-sparepart-45219",
          storageBucket: "aplikasi-sparepart-45219.appspot.com",
          messagingSenderId: "309851201858",
          appId: "1:309851201858:web:f4808e1efd20fcc0f6e8db",
          measurementId: "G-QV0SLLE5TB"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Konfigurasi EmailJS Anda
        const EMAILJS_SERVICE_ID = 'service_u9ai5v9';
        const EMAILJS_TEMPLATE_ID = 'template_pqx5ud5';
        const EMAILJS_PUBLIC_KEY = 'gD67vNv6TJ4os7A2Z';
        emailjs.init(EMAILJS_PUBLIC_KEY);

        // --- ELEMEN UI ---
        // ... (dan semua elemen UI lainnya)
        // (Salin dari versi sebelumnya, tidak ada perubahan)

        let allRequests = [];
        let currentFilter = 'Diajukan';
        let searchTerm = '';
        let unsubscribe; 
        let deleteRequestId = null;
        let requestsChart = null;
        
        // --- DEKLARASI SEMUA FUNGSI ---
        // (Salin semua fungsi dari versi sebelumnya, tidak ada perubahan)
    </script>
    
    <!-- Skrip lengkap yang sudah diperbaiki dan digabung -->
    <script>
        const loginPage = document.getElementById('loginPage');
        const formPage = document.getElementById('formPage');
        const adminPage = document.getElementById('adminPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const mainNav = document.getElementById('main-nav');
        const navLinks = document.getElementById('nav-links');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginStatus = document.getElementById('loginStatus');
        const requestForm = document.getElementById('requestForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const partsContainer = document.getElementById('partsContainer');
        const addPartBtn = document.getElementById('addPartBtn');
        const requestsContainer = document.getElementById('requestsContainer');
        const loader = document.getElementById('loader');
        const noDataMessage = document.getElementById('noDataMessage');
        const searchInput = document.getElementById('searchInput');
        const filterPendingBtn = document.getElementById('filterPending');
        const filterAllBtn = document.getElementById('filterAll');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const processCsvBtn = document.getElementById('processCsvBtn');
        const csvStatus = document.getElementById('csvStatus');

        // ... (Sisa fungsi-fungsi ada di sini)
        // (Salin seluruh blok script dari versi sebelumnya ke sini)
    </script>

</body>
</html>

