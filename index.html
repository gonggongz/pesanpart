<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Permintaan Sparepart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .filter-btn.active { background-color: #2563eb; color: white; }
        .filter-btn.inactive { background-color: #4a5568; color: #d1d5db; }
        .nav-link.active { background-color: #2563eb; }
        @media print { body > .container, body > #main-nav { display: none; } }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Navigasi Utama (ditampilkan setelah login) -->
    <nav id="main-nav" class="bg-gray-800 shadow-md p-4 hidden">
        <div class="container mx-auto flex justify-between items-center">
            <div id="nav-links" class="flex items-center space-x-2">
                 <!-- Navigasi untuk Admin -->
            </div>
            <div class="flex items-center space-x-4">
                <span id="welcomeMessage" class="text-gray-300"></span>
                <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Kontainer Halaman -->
    <div id="app-container" class="container mx-auto p-4 md:p-8">
        
        <!-- Halaman Login -->
        <div id="loginPage">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Selamat Datang</h1>
                <p class="text-gray-400 mt-2">Silakan login untuk mengakses sistem.</p>
            </header>
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-md mx-auto">
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                        <input type="text" id="username" name="username" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" name="password" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                </form>
                <p id="loginStatus" class="mt-4 text-center text-red-400"></p>
            </div>
        </div>

        <!-- Halaman Formulir -->
        <div id="formPage" class="hidden">
             <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Formulir Permintaan Sparepart</h1>
                <p class="text-gray-400 mt-2">Isi detail permintaan di bawah ini.</p>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 max-w-4xl mx-auto">
                <form id="requestForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label for="namaPemesan" class="block text-sm font-medium text-gray-300 mb-1">Nama Pemesan</label>
                            <input type="text" id="namaPemesan" name="namaPemesan" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                        </div>
                        <div>
                            <label for="cabang" class="block text-sm font-medium text-gray-300 mb-1">Cabang</label>
                            <select id="cabang" name="cabang" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                                <option value="">Pilih Cabang</option>
                                <option value="Pungkur">Pungkur</option><option value="Ariajipang">Ariajipang</option><option value="Cibiru">Cibiru</option><option value="Kopo">Kopo</option><option value="Karawang">Karawang</option><option value="Cirebon">Cirebon</option><option value="Tasikmalaya">Tasikmalaya</option><option value="Garut">Garut</option><option value="Jatibarang">Jatibarang</option>
                            </select>
                        </div>
                        <div>
                            <label for="jenisOrder" class="block text-sm font-medium text-gray-300 mb-1">Jenis Order</label>
                            <select id="jenisOrder" name="jenisOrder" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" required>
                                <option value="Regular">Regular</option><option value="Urgent">Urgent</option><option value="Costumer Order">Costumer Order</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="keterangan" class="block text-sm font-medium text-gray-300 mb-1">Keterangan (Opsional)</label>
                            <textarea id="keterangan" name="keterangan" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white"></textarea>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-200">Item Sparepart</h3>
                    <div id="partsContainer" class="space-y-4"></div>
                    <div class="flex justify-between items-center mt-4">
                        <button type="button" id="addPartBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Part</button>
                        <button type="submit" id="submitButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg inline-flex items-center">
                            <svg id="submitIcon" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                            <span id="submitText">Ajukan Permintaan</span>
                            <div id="submitLoader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 mr-2 hidden"></div>
                        </button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </div>
        </div>

        <!-- Halaman Admin (Daftar Permintaan) -->
        <div id="adminPage" class="hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-semibold">Daftar Permintaan</h2>
                    <div class="w-full md:w-auto flex flex-col md:flex-row items-center gap-4">
                        <div class="relative w-full md:w-64">
                            <input type="search" id="searchInput" name="searchInput" placeholder="Cari ID, Nama, Cabang..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 pl-10 pr-4 text-white text-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                               <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="filterPending" class="filter-btn active font-semibold py-2 px-4 rounded-md text-sm">Belum Disetujui</button>
                            <button id="filterAll" class="filter-btn inactive font-semibold py-2 px-4 rounded-md text-sm">Semua</button>
                        </div>
                    </div>
                </div>
                <div id="loader" class="flex justify-center items-center py-10">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
                </div>
                <div id="requestsContainer" class="space-y-6"></div>
                <p id="noDataMessage" class="text-center text-gray-500 py-10 hidden">Belum ada data permintaan.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-white">Hapus Permintaan</h3>
                            <div class="mt-2"><p class="text-sm text-gray-400">Apakah Anda yakin? Tindakan ini tidak dapat dibatalkan.</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirmDelete" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Hapus</button>
                    <button type="button" id="cancelDelete" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-500 shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-500 sm:mt-0 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const  = "https://script.google.com/macros/s/AKfycbw4Ht_RHsltqO2KjiTVXAhrt9uOZB_3yA21zkumFp1e2I9sSP5bPnQJCgi_gk4BJHnq/exec"; // GANTI DENGAN URL WEB APP ANDA
        if (SCRIPT_URL.includes("https://script.google.com/macros/s/AKfycbw4Ht_RHsltqO2KjiTVXAhrt9uOZB_3yA21zkumFp1e2I9sSP5bPnQJCgi_gk4BJHnq/exec")) {
            document.body.innerHTML = `<div class="h-screen flex items-center justify-center bg-gray-900"><div class="text-center p-8 bg-gray-800 rounded-lg shadow-lg max-w-2xl border border-red-500"><h1 class="text-3xl font-bold text-red-400 mb-4">KONFIGURASI DIPERLUKAN</h1><p class="text-gray-300 mb-6">URL Google Apps Script belum diatur. Ganti URL placeholder di file index.html, lalu deploy ulang.</p></div></div>`;
            throw new Error("SCRIPT_URL is not configured.");
        }

        // --- Elemen-elemen Halaman ---
        const loginPage = document.getElementById('loginPage');
        const formPage = document.getElementById('formPage');
        const adminPage = document.getElementById('adminPage');
        const mainNav = document.getElementById('main-nav');
        const navLinks = document.getElementById('nav-links');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginStatus = document.getElementById('loginStatus');
        const requestForm = document.getElementById('requestForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const partsContainer = document.getElementById('partsContainer');
        const addPartBtn = document.getElementById('addPartBtn');
        const requestsContainer = document.getElementById('requestsContainer');
        const loader = document.getElementById('loader');
        const noDataMessage = document.getElementById('noDataMessage');
        const searchInput = document.getElementById('searchInput');
        const filterPendingBtn = document.getElementById('filterPending');
        const filterAllBtn = document.getElementById('filterAll');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        
        let allRequests = [];
        let currentFilter = 'Diajukan';
        let searchTerm = '';
        let deleteId = null;

        // --- Logika Navigasi dan Halaman ---
        const showPage = (page) => {
            loginPage.style.display = 'none';
            formPage.style.display = 'none';
            adminPage.style.display = 'none';
            page.style.display = 'block';
        };

        const setupUIForUser = (user) => {
            mainNav.style.display = 'block';
            welcomeMessage.textContent = `Selamat datang, ${user.username}!`;
            
            navLinks.innerHTML = '';
            const formLink = document.createElement('button');
            formLink.textContent = 'Buat Permintaan';
            formLink.className = 'nav-link font-semibold py-2 px-4 rounded-md text-sm transition-colors';
            formLink.onclick = () => { showPage(formPage); updateNavLinks('form'); };
            navLinks.appendChild(formLink);

            if (user.role === 'admin') {
                const adminLink = document.createElement('button');
                adminLink.textContent = 'Daftar Permintaan';
                adminLink.className = 'nav-link font-semibold py-2 px-4 rounded-md text-sm transition-colors';
                adminLink.onclick = () => { showPage(adminPage); fetchRequests(); updateNavLinks('admin'); };
                navLinks.appendChild(adminLink);
                showPage(adminPage);
                fetchRequests();
                updateNavLinks('admin');
            } else {
                showPage(formPage);
                updateNavLinks('form');
            }
        };

        const updateNavLinks = (activePage) => {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if ((activePage === 'form' && link.textContent === 'Buat Permintaan') ||
                    (activePage === 'admin' && link.textContent === 'Daftar Permintaan')) {
                    link.classList.add('active');
                }
            });
        };

        // --- FUNGSI-FUNGSI UTAMA ---
        const handleLogin = async (e) => {
            e.preventDefault();
            loginStatus.textContent = '';
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', credentials: { username, password } }) });
                const result = await response.json();
                if (result.success) {
                    sessionStorage.setItem('currentUser', JSON.stringify(result.user));
                    setupUIForUser(result.user);
                } else {
                    loginStatus.textContent = result.message;
                }
            } catch (error) {
                loginStatus.textContent = 'Koneksi gagal.';
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        };

        const handleLogout = () => {
            sessionStorage.removeItem('currentUser');
            location.reload();
        };

        document.getElementById('logoutButton').addEventListener('click', handleLogout);
        loginForm.addEventListener('submit', handleLogin);
        
        const addPartRow = () => {
            const partId = Date.now();
            const partRow = document.createElement('div');
            partRow.className = 'p-4 border border-gray-700 rounded-lg grid grid-cols-1 md:grid-cols-12 gap-4 items-end relative';
            partRow.id = `part-${partId}`;
            partRow.innerHTML = `
                <div class="md:col-span-4 relative">
                    <label class="block text-xs font-medium text-gray-400 mb-1">Kode Sparepart</label>
                    <input type="text" name="kodeSparepart" onblur="findPartName(event)" class="w-full bg-gray-600 border border-gray-500 rounded-md py-2 px-3 text-white text-sm" required>
                    <div class="part-notification absolute text-xs text-red-400 mt-1"></div>
                </div>
                <div class="md:col-span-5">
                    <label class="block text-xs font-medium text-gray-400 mb-1">Nama Sparepart</label>
                    <input type="text" name="namaSparepart" class="w-full bg-gray-600 border border-gray-500 rounded-md py-2 px-3 text-white text-sm" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-gray-400 mb-1">Jumlah</label>
                    <input type="number" name="jumlah" min="1" class="w-full bg-gray-600 border border-gray-500 rounded-md py-2 px-3 text-white text-sm" required>
                </div>
                <div class="md:col-span-1">
                    <button type="button" onclick="removePartRow('part-${partId}')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-md">&times;</button>
                </div>
            `;
            partsContainer.appendChild(partRow);
        };

        window.findPartName = async (event) => {
            const partCodeInput = event.target;
            const partCode = partCodeInput.value.trim();
            const partRow = partCodeInput.closest('.p-4');
            const partNameInput = partRow.querySelector('[name=namaSparepart]');
            const notificationDiv = partRow.querySelector('.part-notification');
            notificationDiv.textContent = '';
            partCodeInput.classList.remove('border-red-500');
            if (!partCode) { partNameInput.value = ''; return; }
            partNameInput.value = 'Mencari...';
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getPartName', partCode }) });
                const result = await response.json();
                if (result.success) {
                    partNameInput.value = result.partName;
                } else {
                    partNameInput.value = '';
                    notificationDiv.textContent = result.message;
                    partCodeInput.classList.add('border-red-500');
                }
            } catch (error) {
                partNameInput.value = '';
                notificationDiv.textContent = 'Error koneksi.';
                partCodeInput.classList.add('border-red-500');
            }
        };

        window.removePartRow = (partId) => {
            if (partsContainer.children.length > 1) {
                document.getElementById(partId).remove();
            } else {
                alert('Minimal harus ada satu item sparepart.');
            }
        };

        addPartBtn.addEventListener('click', addPartRow);

        const getStatusBadge = (status) => {
            switch (status) {
                case 'Disetujui': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-200 text-green-800">${status}</span>`;
                case 'Ditolak': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-200 text-red-800">${status}</span>`;
                default: return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-200 text-yellow-800">${status}</span>`;
            }
        };

        const getOrderTypeBadge = (orderType) => {
            switch (orderType) {
                case 'Urgent': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-200 text-red-800">${orderType}</span>`;
                case 'Costumer Order': return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-200 text-purple-800">${orderType}</span>`;
                default: return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-200 text-blue-800">${orderType}</span>`;
            }
        };

        const renderRequests = () => {
            requestsContainer.innerHTML = '';
            noDataMessage.style.display = 'none';
            let filteredData = [...allRequests];
            if (currentFilter === 'Diajukan') {
                filteredData = filteredData.filter(req => req.status === 'Diajukan');
            }
            const lowercasedSearchTerm = searchTerm.toLowerCase();
            if (lowercasedSearchTerm) {
                filteredData = filteredData.filter(req =>
                    (req.id && req.id.toLowerCase().includes(lowercasedSearchTerm)) ||
                    (req.namaPemesan && req.namaPemesan.toLowerCase().includes(lowercasedSearchTerm)) ||
                    (req.cabang && req.cabang.toLowerCase().includes(lowercasedSearchTerm))
                );
            }
            if (filteredData.length > 0) {
                filteredData.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 p-5 rounded-lg shadow-md';
                    let partsHtml = '<ul class="divide-y divide-gray-600 mt-3">';
                    req.parts.forEach(part => {
                        partsHtml += `<li class="py-2 flex justify-between items-center text-sm"><div><p class="font-semibold text-white">${part.namaSparepart}</p><p class="text-gray-400">${part.kodeSparepart}</p></div><p class="text-white">x ${part.jumlah}</p></li>`;
                    });
                    partsHtml += '</ul>';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm text-gray-400">ID: ${req.id}</p><h3 class="text-xl font-bold text-white">${req.namaPemesan} - <span class="font-normal">${req.cabang}</span></h3><p class="text-xs text-gray-400 mt-1">${new Date(req.timestamp).toLocaleString('id-ID')}</p></div>
                            <div class="flex flex-col items-end gap-2">${getStatusBadge(req.status)}${getOrderTypeBadge(req.jenisOrder)}</div>
                        </div>
                        ${req.keterangan ? `<div class="mt-3 p-3 bg-gray-600 rounded-md text-sm text-gray-300"><strong>Catatan:</strong> ${req.keterangan}</div>` : ''}
                        <div class="mt-2 border-t border-gray-600 pt-2"><h4 class="text-md font-semibold text-gray-200">Daftar Item:</h4>${partsHtml}</div>
                        <div class="mt-4 border-t border-gray-600 pt-4 flex justify-end space-x-3">
                            <button onclick="printRequest('${req.id}')" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Print</button>
                            <button onclick="updateRequestStatus('${req.id}', 'Disetujui')" class="text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md ${req.status !== 'Diajukan' ? 'opacity-50 cursor-not-allowed' : ''}" ${req.status !== 'Diajukan' ? 'disabled' : ''}>Setujui</button>
                            <button onclick="updateRequestStatus('${req.id}', 'Ditolak')" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md ${req.status !== 'Diajukan' ? 'opacity-50 cursor-not-allowed' : ''}" ${req.status !== 'Diajukan' ? 'disabled' : ''}>Tolak</button>
                            <button onclick="openDeleteModal('${req.id}')" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Hapus</button>
                        </div>`;
                    requestsContainer.appendChild(card);
                });
            } else {
                noDataMessage.textContent = 'Tidak ada permintaan yang cocok.';
                noDataMessage.style.display = 'block';
            }
        };

        const fetchRequests = async () => {
            loader.style.display = 'flex';
            requestsContainer.innerHTML = '';
            noDataMessage.style.display = 'none';
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getRequests' }) });
                const result = await response.json();
                if (result.success) {
                    allRequests = result.data;
                    renderRequests();
                } else {
                    noDataMessage.textContent = result.message;
                    noDataMessage.style.display = 'block';
                }
            } catch (error) {
                noDataMessage.textContent = 'Gagal memuat data.';
                noDataMessage.style.display = 'block';
            } finally {
                loader.style.display = 'none';
            }
        };

        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');
            const submitIcon = document.getElementById('submitIcon');
            submitText.textContent = 'Mengirim...'; submitLoader.style.display = 'block'; submitIcon.style.display = 'none'; submitButton.disabled = true;
            const requestData = { namaPemesan: requestForm.namaPemesan.value, cabang: requestForm.cabang.value, jenisOrder: requestForm.jenisOrder.value, keterangan: requestForm.keterangan.value, parts: [] };
            partsContainer.querySelectorAll('.p-4').forEach(row => {
                requestData.parts.push({ kodeSparepart: row.querySelector('[name=kodeSparepart]').value, namaSparepart: row.querySelector('[name=namaSparepart]').value, jumlah: row.querySelector('[name=jumlah]').value });
            });
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addRequest', data: requestData }) });
                const result = await response.json();
                statusMessage.textContent = result.message;
                statusMessage.className = result.success ? 'text-green-400 mt-4 text-center' : 'text-red-400 mt-4 text-center';
                if (result.success) {
                    requestForm.reset();
                    partsContainer.innerHTML = '';
                    addPartRow();
                    if(JSON.parse(sessionStorage.getItem('currentUser')).role === 'admin') { fetchRequests(); }
                }
            } catch (error) {
                statusMessage.textContent = 'Terjadi kesalahan.'; statusMessage.className = 'text-red-400 mt-4 text-center';
            } finally {
                setTimeout(() => {
                    submitText.textContent = 'Ajukan Permintaan'; submitLoader.style.display = 'none'; submitIcon.style.display = 'block'; submitButton.disabled = false; statusMessage.textContent = '';
                }, 3000);
            }
        });

        window.printRequest = (id) => {
            const req = allRequests.find(r => r.id === id);
            if (!req) return;
            let partsRows = '';
            req.parts.forEach((part, index) => {
                partsRows += `<tr><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${index + 1}</td><td style="border: 1px solid #ddd; padding: 8px;">${part.kodeSparepart}</td><td style="border: 1px solid #ddd; padding: 8px;">${part.namaSparepart}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${part.jumlah}</td></tr>`;
            });
            const printContent = `<html><head><title>Cetak ${req.id}</title><style>body{font-family:sans-serif;font-size:12px}.container{width:90%;margin:0 auto}h1,h2{text-align:center}.header-info{overflow:auto;margin-bottom:20px}.header-info div{float:left;width:50%}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background-color:#f2f2f2}.signatures{margin-top:50px;overflow:auto}.signatures div{float:left;width:33.33%;text-align:center}.signatures p{margin-top:60px}@media print{.no-print{display:none}}</style></head><body><div class="container"><h1>Formulir Permintaan Sparepart</h1><hr><div class="header-info"><div><p><strong>ID:</strong> ${req.id}</p><p><strong>Nama Pemesan:</strong> ${req.namaPemesan}</p><p><strong>Cabang:</strong> ${req.cabang}</p></div><div><p><strong>Tanggal:</strong> ${new Date(req.timestamp).toLocaleDateString('id-ID')}</p><p><strong>Jenis Order:</strong> ${req.jenisOrder}</p><p><strong>Status:</strong> ${req.status}</p></div></div>${req.keterangan ? `<p><strong>Keterangan:</strong> ${req.keterangan}</p>` : ''}<h2>Detail Item</h2><table><thead><tr><th style="width:5%">No.</th><th style="width:25%">Kode</th><th>Nama Sparepart</th><th style="width:10%">Jumlah</th></tr></thead><tbody>${partsRows}</tbody></table><div class="signatures"><div><p>Pemohon,</p><p><strong>(${req.namaPemesan})</strong></p></div><div><p>Mengetahui,</p><p>(_________________________)</p></div><div><p>Menyetujui,</p><p>(_________________________)</p></div></div><button class="no-print" onclick="window.print()" style="margin-top:20px;padding:10px 20px">Cetak</button></div></body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.updateRequestStatus = async (id, newStatus) => {
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id, newStatus }) });
                const result = await response.json();
                if (result.success) fetchRequests(); else alert('Gagal: ' + result.message);
            } catch (error) { alert('Koneksi gagal.'); }
        };
        
        window.openDeleteModal = (id) => { deleteId = id; deleteModal.style.display = 'block'; };
        
        cancelDeleteBtn.addEventListener('click', () => { deleteModal.style.display = 'none'; deleteId = null; });
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!deleteId) return;
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteRequest', id: deleteId }) });
                const result = await response.json();
                if (result.success) fetchRequests(); else alert('Gagal menghapus: ' + result.message);
            } catch (error) { alert('Koneksi gagal.'); } finally { deleteModal.style.display = 'none'; deleteId = null; }
        });
        
        searchInput.addEventListener('input', (e) => { searchTerm = e.target.value; renderRequests(); });
        
        filterPendingBtn.addEventListener('click', () => {
            currentFilter = 'Diajukan';
            filterPendingBtn.classList.replace('inactive', 'active');
            filterAllBtn.classList.replace('active', 'inactive');
            renderRequests();
        });

        filterAllBtn.addEventListener('click', () => {
            currentFilter = 'Semua';
            filterAllBtn.classList.replace('inactive', 'active');
            filterPendingBtn.classList.replace('active', 'inactive');
            renderRequests();
        });

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                setupUIForUser(JSON.parse(user));
            } else {
                showPage(loginPage);
            }
            addPartRow();
        });
    </script>
</body>
</html>

